@page "{bookingId:int}"
@model PaymentIndexModel
@{
    ViewData["Title"] = "Płatność";
}

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h3><i class="fas fa-credit-card me-2"></i>Finalizacja płatności</h3>
            </div>
            <div class="card-body">
                <!-- Podsumowanie -->
                <div class="alert alert-info">
                    <h5><i class="fas fa-info-circle me-2"></i>Podsumowanie zamówienia</h5>
                    <p class="mb-0">Kwota do zapłaty: <strong>@Model.Payment.Amount.ToString("C")</strong></p>
                </div>

                <form method="post" id="paymentForm">
                    <input type="hidden" asp-for="Payment.BookingId" />
                    <input type="hidden" asp-for="Payment.Amount" />

                    <!-- Wybór metody płatności -->
                    <div class="mb-4">
                        <h5>Wybierz metodę płatności:</h5>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="card payment-method" data-method="Card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-credit-card fa-3x text-primary mb-2"></i>
                                        <h6>Karta płatnicza</h6>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card payment-method" data-method="BLIK">
                                    <div class="card-body text-center">
                                        <i class="fas fa-mobile-alt fa-3x text-success mb-2"></i>
                                        <h6>BLIK</h6>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card payment-method" data-method="Transfer">
                                    <div class="card-body text-center">
                                        <i class="fas fa-university fa-3x text-info mb-2"></i>
                                        <h6>Przelew bankowy</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" asp-for="Payment.PaymentMethod" id="selectedMethod" />

                    <!-- Formularz karty -->
                    <div id="cardForm" class="payment-form" style="display: none;">
                        <h5><i class="fas fa-credit-card me-2"></i>Dane karty płatniczej</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Numer karty</label>
                                <input type="text" class="form-control" placeholder="1234 5678 9012 3456"
                                       maxlength="19" id="cardNumber" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Imię i nazwisko</label>
                                <input type="text" class="form-control" placeholder="Jan Kowalski" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Data ważności</label>
                                <input type="text" class="form-control" placeholder="MM/YY"
                                       maxlength="5" id="expiryDate" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">CVV</label>
                                <input type="text" class="form-control" placeholder="123"
                                       maxlength="4" id="cvv" />
                            </div>
                        </div>
                    </div>

                    <!-- Formularz BLIK -->
                    <div id="blikForm" class="payment-form" style="display: none;">
                        <h5><i class="fas fa-mobile-alt me-2"></i>Płatność BLIK</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Kod BLIK (6 cyfr)</label>
                                <input type="text" class="form-control text-center" placeholder="123456"
                                       maxlength="6" id="blikCode" style="font-size: 1.5rem; letter-spacing: 0.5rem;" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Numer telefonu</label>
                                <input type="tel" class="form-control" placeholder="+48 123 456 789" />
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Wygeneruj kod BLIK w aplikacji mobilnej swojego banku i wprowadź go powyżej.
                        </div>
                    </div>

                    <!-- Formularz przelewu -->
                    <div id="transferForm" class="payment-form" style="display: none;">
                        <h5><i class="fas fa-university me-2"></i>Przelew bankowy</h5>
                        <div class="mb-3">
                            <label class="form-label">Wybierz swój bank</label>
                            <select class="form-select">
                                <option value="">-- Wybierz bank --</option>
                                <option value="pko">PKO Bank Polski</option>
                                <option value="pekao">Bank Pekao</option>
                                <option value="mbank">mBank</option>
                                <option value="ing">ING Bank Śląski</option>
                                <option value="santander">Santander Bank</option>
                                <option value="millennium">Bank Millennium</option>
                                <option value="alior">Alior Bank</option>
                                <option value="getin">Getin Noble Bank</option>
                            </select>
                        </div>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Zostaniesz przekierowany do strony swojego banku, aby dokończyć płatność.
                        </div>
                    </div>

                    <!-- Przyciski -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-between mt-4">
                        <a href="javascript:history.back()" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Wróć
                        </a>
                        <button type="submit" class="btn btn-success btn-lg" id="payButton" disabled>
                            <i class="fas fa-lock me-2"></i>Zapłać @Model.Payment.Amount.ToString("C")
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Payment method selection
        document.querySelectorAll('.payment-method').forEach(method => {
            method.addEventListener('click', function() {
                // Remove active class from all
                document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('border-primary', 'bg-light'));

                // Add active class to selected
                this.classList.add('border-primary', 'bg-light');

                // Hide all forms
                document.querySelectorAll('.payment-form').forEach(form => form.style.display = 'none');

                // Show selected form
                const selectedMethod = this.getAttribute('data-method');
                document.getElementById('selectedMethod').value = selectedMethod;

                if (selectedMethod === 'Card') {
                    document.getElementById('cardForm').style.display = 'block';
                } else if (selectedMethod === 'BLIK') {
                    document.getElementById('blikForm').style.display = 'block';
                } else if (selectedMethod === 'Transfer') {
                    document.getElementById('transferForm').style.display = 'block';
                }

                document.getElementById('payButton').disabled = false;
            });
        });

        // Card number formatting
        document.getElementById('cardNumber')?.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
        });

        // Expiry date formatting
        document.getElementById('expiryDate')?.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        });

        // CVV formatting
        document.getElementById('cvv')?.addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        });

        // BLIK code formatting
        document.getElementById('blikCode')?.addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        });

        // Form submission
        document.getElementById('paymentForm').addEventListener('submit', function(e) {
            const payButton = document.getElementById('payButton');
            payButton.disabled = true;
            payButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Przetwarzanie...';
        });
    </script>

    <style>
        .payment-method {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

            .payment-method:hover {
                border-color: #0d6efd;
                background-color: #f8f9fa;
            }

        .payment-form {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            background-color: #f8f9fa;
        }
    </style>
}